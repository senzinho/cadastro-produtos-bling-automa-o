<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Pre√ßos</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            padding: 30px 20px;
            transition: all 0.3s ease;
            background: #f5f7fa;
            color: #2d3748;
        }

        body.dark {
            background: #0f1419;
            color: #e2e8f0;
        }

        #auth-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 9999;
            background: #f5f7fa;
        }

        body.dark #auth-loading {
            background: #0f1419;
        }

        #auth-loading h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        body.dark #auth-loading h2 {
            color: #e2e8f0;
        }

        .auth-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #41644A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        body.dark .auth-spinner {
            border-color: #2d3748;
            border-top-color: #68d391;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #app {
            max-width: 1800px;
            margin: 0 auto;
            position: relative;
            display: none;
        }

        #app.loaded {
            display: block;
        }

        .header {
            margin-bottom: 40px;
            text-align: center;
            position: relative;
        }

        .user-badge {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            color: #2d3748;
        }

        body.dark .user-badge {
            background: #1a202c;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border: 1px solid #2d3748;
            color: #f7fafc;
        }

        .user-badge svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .btn-logout-calc {
            margin-left: 8px;
            padding: 4px 12px;
            border: 1px solid #e53e3e;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: #e53e3e;
        }

        .btn-logout-calc:hover {
            background: #e53e3e;
            color: white;
        }

        body.dark .btn-logout-calc {
            border-color: #fc8181;
            color: #fc8181;
        }

        body.dark .btn-logout-calc:hover {
            background: #fc8181;
            color: #1a202c;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #41644A;
        }

        body.dark .header h1 {
            color: #68d391;
        }

        .header p {
            font-size: 1.1rem;
            color: #718096;
        }

        body.dark .header p {
            color: #a0aec0;
        }

        .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background: #fff3cd;
            color: #f59e0b;
        }

        body.dark .theme-toggle {
            background: #2d3748;
            color: #fbb6ce;
            box-shadow: 0 2px 8px rgba(251, 182, 206, 0.3);
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(10deg);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
            transition: transform 0.3s ease;
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
            flex-shrink: 0;
        }

        .icon-large {
            width: 32px;
            height: 32px;
            fill: currentColor;
        }

        .container {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 25px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        body.dark .card {
            background: #1a202c;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border: 1px solid #2d3748;
        }

        .card h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2d3748;
        }

        body.dark .card h2 {
            color: #f7fafc;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4a5568;
        }

        body.dark .input-group label {
            color: #cbd5e0;
        }

        .input-group input[type="number"] {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background: #f7fafc;
            color: #2d3748;
        }

        .input-group input[type="number"]:focus {
            outline: none;
            border-color: #41644A;
            background: white;
        }

        body.dark .input-group input[type="number"] {
            background: #2d3748;
            border-color: #4a5568;
            color: #f7fafc;
        }

        body.dark .input-group input[type="number"]:focus {
            border-color: #68d391;
            background: #374151;
        }

        .slider-group {
            margin-bottom: 20px;
        }

        .slider-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4a5568;
        }

        body.dark .slider-group label {
            color: #cbd5e0;
        }

        .slider-value {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #41644A;
        }

        body.dark .slider-value {
            color: #68d391;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            outline: none;
            -webkit-appearance: none;
            border-radius: 3px;
            background: #e2e8f0;
        }

        body.dark input[type="range"] {
            background: #4a5568;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            background: #41644A;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        body.dark input[type="range"]::-webkit-slider-thumb {
            background: #68d391;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            background: #41644A;
            transition: transform 0.2s;
        }

        body.dark input[type="range"]::-moz-range-thumb {
            background: #68d391;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.15);
        }

        .selector {
            margin-bottom: 20px;
        }

        .selector label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4a5568;
        }

        body.dark .selector label {
            color: #cbd5e0;
        }

        .selector-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 6px;
            background: #f7fafc;
        }

        body.dark .selector-controls {
            background: #2d3748;
            border-color: #4a5568;
        }

        .btn-nav {
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            color: #41644A;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn-nav:hover {
            background: #41644A;
            color: white;
            transform: scale(1.05);
        }

        body.dark .btn-nav {
            background: #374151;
            color: #68d391;
        }

        body.dark .btn-nav:hover {
            background: #68d391;
            color: #1a202c;
        }

        .btn-nav svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .selector-value {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 500;
            text-align: center;
            color: #2d3748;
        }

        body.dark .selector-value {
            color: #f7fafc;
        }

        .marketplace-selector {
            margin-bottom: 20px;
        }

        .marketplace-list-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #f7fafc;
        }

        body.dark .marketplace-list-selector {
            background: #2d3748;
            border-color: #4a5568;
        }

        /* NOVO: Grupo de Mercado Livre */
        .marketplace-group {
            border-bottom: 1px solid #e2e8f0;
        }

        body.dark .marketplace-group {
            border-bottom-color: #4a5568;
        }

        .marketplace-group-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            background: #edf2f7;
            font-weight: 600;
        }

        body.dark .marketplace-group-header {
            background: #374151;
        }

        .marketplace-group-header:hover {
            background: #e2e8f0;
        }

        body.dark .marketplace-group-header:hover {
            background: #4a5568;
        }

        .group-expand-icon {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            transition: transform 0.3s;
            fill: currentColor;
        }

        .marketplace-group.expanded .group-expand-icon {
            transform: rotate(90deg);
        }

        .marketplace-group-items {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .marketplace-group.expanded .marketplace-group-items {
            max-height: 200px;
        }

        .marketplace-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s;
            cursor: pointer;
        }

        body.dark .marketplace-item {
            border-bottom-color: #4a5568;
        }

        .marketplace-item:last-child {
            border-bottom: none;
        }

        .marketplace-item:hover {
            background: #edf2f7;
        }

        body.dark .marketplace-item:hover {
            background: #374151;
        }

        /* Indenta√ß√£o para sub-itens do grupo */
        .marketplace-group-items .marketplace-item {
            padding-left: 45px;
            background: #fafbfc;
        }

        body.dark .marketplace-group-items .marketplace-item {
            background: #2d3748;
        }

        .marketplace-group-items .marketplace-item:hover {
            background: #f1f5f9;
        }

        body.dark .marketplace-group-items .marketplace-item:hover {
            background: #3d4a5c;
        }

        .marketplace-checkbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #41644A;
        }

        body.dark .marketplace-checkbox {
            accent-color: #68d391;
        }

        .marketplace-item-name {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 500;
            color: #2d3748;
        }

        body.dark .marketplace-item-name {
            color: #f7fafc;
        }

        .marketplace-commission {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 4px;
            color: #718096;
            background: #e2e8f0;
        }

        body.dark .marketplace-commission {
            color: #cbd5e0;
            background: #4a5568;
        }

        .select-all-btn {
            width: 100%;
            padding: 8px;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 10px;
            background: #41644A;
        }

        .select-all-btn:hover {
            background: #2d4832;
        }

        body.dark .select-all-btn {
            background: #68d391;
            color: #1a202c;
        }

        body.dark .select-all-btn:hover {
            background: #48bb78;
        }

        .selected-count {
            font-size: 0.8rem;
            text-align: center;
            margin-bottom: 10px;
            color: #718096;
        }

        body.dark .selected-count {
            color: #a0aec0;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .stat-card {
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        body.dark .stat-card {
            background: #1a202c;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            border: 1px solid #2d3748;
        }

        .stat-label {
            font-size: 0.85rem;
            margin-bottom: 8px;
            font-weight: 500;
            color: #718096;
        }

        body.dark .stat-label {
            color: #a0aec0;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #41644A;
        }

        body.dark .stat-value {
            color: #68d391;
        }

        .marketplace-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* NOVO: Agrupamento visual dos resultados do Mercado Livre */
        .marketplace-results-group {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px;
            background: #fafbfc;
        }

        body.dark .marketplace-results-group {
            background: #1a202c;
            border-color: #4a5568;
        }

        .marketplace-results-group-title {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            color: #41644A;
            background: #f0fdf4;
        }

        body.dark .marketplace-results-group-title {
            color: #68d391;
            background: #2d3748;
        }

        .marketplace-row {
            border-radius: 10px;
            padding: 16px 24px;
            transition: all 0.25s ease;
            border-left: 4px solid transparent;
            display: grid;
            grid-template-columns: 180px 1fr auto;
            align-items: center;
            gap: 20px;
            background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }

        .marketplace-row:hover {
            border-left-color: #41644A;
            box-shadow: 0 4px 12px rgba(65,100,74,0.12);
            transform: translateX(6px);
            background: #fafbfc;
        }

        body.dark .marketplace-row {
            background: #1a202c;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 1px solid #2d3748;
        }

        body.dark .marketplace-row:hover {
            border-left-color: #68d391;
            box-shadow: 0 6px 16px rgba(104, 211, 145, 0.15);
            background: #242d3a;
        }

        .marketplace-name {
            font-size: 1rem;
            font-weight: 600;
            white-space: nowrap;
            color: #41644A;
        }

        body.dark .marketplace-name {
            color: #68d391;
        }

        .marketplace-info {
            display: flex;
            gap: 24px;
            align-items: center;
            flex-wrap: wrap;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .info-label {
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #718096;
        }

        body.dark .info-label {
            color: #a0aec0;
        }

        .info-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d3748;
        }

        body.dark .info-value {
            color: #f7fafc;
        }

        .marketplace-price-container {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: flex-end;
            min-width: 140px;
        }

        .marketplace-price {
            font-size: 2rem;
            font-weight: 700;
            white-space: nowrap;
            color: #41644A;
        }

        body.dark .marketplace-price {
            color: #68d391;
        }

        .copy-btn {
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: #f7fafc;
            color: #718096;
        }

        .copy-btn:hover {
            background: #41644A;
            color: white;
            transform: scale(1.05);
        }

        body.dark .copy-btn {
            background: #2d3748;
            color: #a0aec0;
        }

        body.dark .copy-btn:hover {
            background: #68d391;
            color: #1a202c;
        }

        .copy-btn.copied {
            animation: copySuccess 0.5s ease;
            background: #48bb78;
            color: white;
        }

        body.dark .copy-btn.copied {
            background: #68d391;
            color: #1a202c;
        }

        .copy-btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        @keyframes copySuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .kits-section {
            grid-column: 1 / -1;
            display: flex;
            gap: 12px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }

        body.dark .kits-section {
            border-top-color: #4a5568;
        }

        .kit-item {
            flex: 1;
            padding: 8px 10px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            background: #f7fafc;
        }

        .kit-item:hover {
            background: #edf2f7;
            transform: translateY(-2px);
        }

        body.dark .kit-item {
            background: #2d3748;
        }

        body.dark .kit-item:hover {
            background: #374151;
        }

        .kit-content {
            flex: 1;
            min-width: 0;
        }

        .kit-name {
            font-size: 0.7rem;
            margin-bottom: 3px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: left;
            color: #718096;
        }

        body.dark .kit-name {
            color: #a0aec0;
        }

        .kit-price {
            font-size: 0.95rem;
            font-weight: 600;
            text-align: left;
            color: #41644A;
        }

        body.dark .kit-price {
            color: #68d391;
        }

        .kit-copy-btn {
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: #e2e8f0;
            color: #718096;
        }

        .kit-copy-btn:hover {
            background: #41644A;
            color: white;
        }

        body.dark .kit-copy-btn {
            background: #374151;
            color: #a0aec0;
        }

        body.dark .kit-copy-btn:hover {
            background: #68d391;
            color: #1a202c;
        }

        .kit-copy-btn.copied {
            animation: copySuccess 0.5s ease;
            background: #48bb78;
            color: white;
        }

        body.dark .kit-copy-btn.copied {
            background: #68d391;
            color: #1a202c;
        }

        .kit-copy-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .reverse-calc {
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            background: #f7fafc;
        }

        body.dark .reverse-calc {
            background: #2d3748;
        }

        .reverse-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }

        .reverse-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #718096;
        }

        body.dark .reverse-label {
            color: #a0aec0;
        }

        .reverse-value {
            font-size: 1.4rem;
            font-weight: 600;
            color: #41644A;
        }

        body.dark .reverse-value {
            color: #68d391;
        }

        .no-stores-message {
            text-align: center;
            padding: 40px 20px;
            color: #718096;
        }

        body.dark .no-stores-message {
            color: #a0aec0;
        }

        .no-stores-message h3 {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #a0aec0;
        }

        body.dark .no-stores-message h3 {
            color: #68d391;
        }

        .loading-message {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-message h2 {
            font-weight: 400;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #718096;
        }

        body.dark .loading-message h2 {
            color: #a0aec0;
        }

        .loading-message p {
            color: #a0aec0;
        }

        body.dark .loading-message p {
            color: #718096;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .marketplace-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .marketplace-info {
                order: 2;
            }

            .marketplace-price-container {
                order: 1;
                justify-content: flex-start;
            }

            .kits-section {
                order: 3;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .marketplace-row {
                padding: 15px 18px;
            }

            .marketplace-info {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .marketplace-price {
                font-size: 1.5rem;
            }

            .kits-section {
                flex-direction: column;
                gap: 8px;
            }

            .theme-toggle {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
            }

            .user-badge {
                position: static;
                justify-content: center;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div id="auth-loading">
        <div class="auth-spinner"></div>
        <h2>üîê Verificando autentica√ß√£o...</h2>
    </div>

    <div id="app">
        <button class="theme-toggle" id="theme-toggle" aria-label="Alternar tema"></button>

        <div class="header">
            <div class="user-badge" id="user-badge">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                </svg>
                <span><strong id="user-name">Carregando...</strong></span>
                <button class="btn-logout-calc" id="btn-logout">Sair</button>
            </div>

            <h1>
                <svg class="icon-large" viewBox="0 0 24 24">
                    <path d="M9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4zm2.5 2.25l1.25-1.25V6c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v12.25l1.25 1.25H18.75z"/>
                </svg>
                Calculadora de Pre√ßos
            </h1>
            <p>An√°lise comparativa de marketplaces selecionados</p>
        </div>

        <div class="container">
            <div class="sidebar">
                <div class="card">
                    <h2>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h4v1a1 1 0 0 0 2 0V9h2v10z"/>
                        </svg>
                        Sele√ß√£o de Marketplaces
                    </h2>
                    
                    <div class="marketplace-selector">
                        <button class="select-all-btn" id="select-all-btn">Selecionar Todos</button>
                        
                        <div class="selected-count" id="selected-count">0 de 0 marketplaces selecionados</div>
                        
                        <div class="marketplace-list-selector" id="marketplace-list-selector">
                            <!-- Marketplaces ser√£o inseridos aqui -->
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                        </svg>
                        Par√¢metros
                    </h2>
                    
                    <div class="input-group">
                        <label>Custo do Produto (R$)</label>
                        <input type="number" id="input-cost" step="0.01" min="0" placeholder="0.00" value="50.00">
                    </div>

                    <div class="slider-group">
                        <label>Margem de Lucro <span style="color: #718096; font-size: 0.8rem; font-weight: 400;">(pode ser negativa)</span></label>
                        <div class="slider-value" id="margin-value">20%</div>
                        <input type="range" id="input-margin" min="-100" max="100" step="1" value="20">
                    </div>

                    <div class="slider-group">
                        <label>Imposto</label>
                        <div class="slider-value" id="tax-value">10%</div>
                        <input type="range" id="input-tax" min="0" max="50" step="0.5" value="10">
                    </div>

                    <div class="selector">
                        <label>Configura√ß√£o de Kits</label>
                        <div class="selector-controls">
                            <button class="btn-nav" id="prev-kit">
                                <svg viewBox="0 0 24 24">
                                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                                </svg>
                            </button>
                            <div class="selector-value" id="kit-name">Carregando...</div>
                            <button class="btn-nav" id="next-kit">
                                <svg viewBox="0 0 24 24">
                                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                        </svg>
                        C√°lculo Reverso
                    </h2>
                    
                    <div class="input-group">
                        <label>Pre√ßo de Venda (R$)</label>
                        <input type="number" id="input-price" step="0.01" min="0" placeholder="0.00" value="98.80">
                    </div>

                    <div class="selector">
                        <label>Marketplace</label>
                        <div class="selector-controls">
                            <button class="btn-nav" id="prev-marketplace">
                                <svg viewBox="0 0 24 24">
                                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                                </svg>
                            </button>
                            <div class="selector-value" id="marketplace-name">Carregando...</div>
                            <button class="btn-nav" id="next-marketplace">
                                <svg viewBox="0 0 24 24">
                                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="reverse-calc hidden" id="reverse-results">
                        <div class="reverse-result">
                            <span class="reverse-label">Custo</span>
                            <span class="reverse-value" id="reverse-cost">R$ 0.00</span>
                        </div>
                        <div class="reverse-result">
                            <span class="reverse-label">Frete</span>
                            <span class="reverse-value" id="reverse-shipment">R$ 0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-content">
                <div class="stats-grid hidden" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Menor Pre√ßo</div>
                        <div class="stat-value" id="stat-min-price">R$ 0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Maior Pre√ßo</div>
                        <div class="stat-value" id="stat-max-price">R$ 0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pre√ßo M√©dio</div>
                        <div class="stat-value" id="stat-avg-price">R$ 0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Lucro M√©dio</div>
                        <div class="stat-value" id="stat-avg-profit">R$ 0.00</div>
                    </div>
                </div>

                <div class="card no-stores-message hidden" id="no-stores-message">
                    <h3>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h4v1a1 1 0 0 0 2 0V9h2v10z"/>
                        </svg>
                        Selecione ao menos um marketplace
                    </h3>
                    <p>Para visualizar os dados, selecione um ou mais marketplaces na lateral esquerda.</p>
                </div>

                <div class="card loading-message" id="loading-message">
                    <h2>
                        <svg class="icon spinner" viewBox="0 0 24 24">
                            <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
                        </svg>
                        Carregando dados...
                    </h2>
                    <p>Aguarde enquanto calculamos os pre√ßos</p>
                </div>

                <div class="card hidden" id="marketplaces-results-card">
                    <h2>
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h4v1a1 1 0 0 0 2 0V9h2v10z"/>
                        </svg>
                        Detalhes por Marketplace (<span id="results-count">0</span> <span id="results-label">marketplaces</span>)
                    </h2>
                    <div class="marketplace-list" id="marketplace-list">
                        <!-- Resultados ser√£o inseridos aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        axios.defaults.withCredentials = true;

        const state = {
            currentUser: null,
            cost: 50.00,
            price: 98.80,
            margin: 20,
            taxRate: 10,
            marketplaceIndex: 0,
            kitIndex: 0,
            marketplaces: [],
            kits: [],
            allPriceResults: [],
            costResults: null,
            selectedMarketplaces: [],
            isDark: false,
            apiUrl: 'http://localhost:5000/api',
            debounceTimer: null,
            mlGroupExpanded: true,        // Estado do grupo Mercado Livre
            shopeeGroupExpanded: true,    // ‚úÖ NOVO - Shopee
            trayGroupExpanded: true       // ‚úÖ NOVO - Tray
        };

        // ==================== AUTENTICA√á√ÉO ====================

        async function checkAuth() {
            try {
                console.log('üîê Verificando autentica√ß√£o...');
                const response = await axios.get(`${state.apiUrl}/me`);
                state.currentUser = response.data;
                console.log('‚úÖ Usu√°rio autenticado:', state.currentUser.name);
                return true;
            } catch (error) {
                console.error('‚ùå Erro de autentica√ß√£o:', error);
                if (error.response && error.response.status === 401) {
                    console.log('‚ö†Ô∏è Usu√°rio n√£o autenticado. Redirecionando para login...');
                    alert('Voc√™ precisa estar logado para acessar a calculadora.');
                    window.location.href = '/login';
                    return false;
                }
                alert('Erro ao verificar autentica√ß√£o. Redirecionando para login...');
                window.location.href = '/login';
                return false;
            }
        }

        function logout() {
            if (confirm('Deseja realmente sair?')) {
                axios.post(`${state.apiUrl}/logout`)
                    .then(() => {
                        console.log('‚úÖ Logout realizado');
                        window.location.href = '/login';
                    })
                    .catch((error) => {
                        console.error('‚ùå Erro ao fazer logout:', error);
                        window.location.href = '/login';
                    });
            }
        }

        // ==================== TEMA ====================

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                state.isDark = savedTheme === 'dark';
            } else {
                state.isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            applyTheme();
            console.log('üé® Tema carregado:', state.isDark ? 'dark' : 'light');
        }

        function applyTheme() {
            document.body.className = state.isDark ? 'dark' : 'light';
            updateThemeIcon();
        }

        function toggleTheme() {
            state.isDark = !state.isDark;
            localStorage.setItem('theme', state.isDark ? 'dark' : 'light');
            applyTheme();
            console.log('üé® Tema alternado para:', state.isDark ? 'dark' : 'light');
        }

        function updateThemeIcon() {
            const themeBtn = document.getElementById('theme-toggle');
            if (!themeBtn) return;
            
            const sunIcon = `
                <svg viewBox="0 0 24 24">
                    <path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
                </svg>
            `;
            
            const moonIcon = `
                <svg viewBox="0 0 24 24">
                    <path d="M12.01 12c0 3.31-2.69 6-6 6s-6-2.69-6-6 2.69-6 6-6 6 2.69 6 6zM21 2l-1.5 1.5-3.5-3.5L14.5.5 16 2l3.5 3.5L21 2zM3.5 21.5L2 20l1.5-1.5L7 22l1.5-1.5L7 19l-3.5 2.5zM20 12.01h2c0-5.52-4.48-10-10-10v2c4.42 0 8 3.58 8 8z"/>
                </svg>
            `;
            
            themeBtn.innerHTML = state.isDark ? moonIcon : sunIcon;
        }

        // ==================== MARKETPLACES ====================

        async function loadMarketplaces() {
            try {
                const response = await axios.get(`${state.apiUrl}/marketplaces`);
                state.marketplaces = response.data;
                state.selectedMarketplaces = state.marketplaces.map((_, i) => i);
                renderMarketplacesList();
                updateSelectedCount();
                await calculateAllPrices();
                await calculateCost();
            } catch (error) {
                console.error('‚ùå Erro ao carregar marketplaces:', error);
            }
        }

        function renderMarketplacesList() {
            const container = document.getElementById('marketplace-list-selector');
            container.innerHTML = '';

            // ==================== GRUPO MERCADO LIVRE ====================
            const mlGroup = document.createElement('div');
            mlGroup.className = 'marketplace-group expanded';
            
            const mlHeader = document.createElement('div');
            mlHeader.className = 'marketplace-group-header';
            mlHeader.innerHTML = `
                <svg class="group-expand-icon" viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
                <input 
                    type="checkbox" 
                    class="marketplace-checkbox"
                    id="ml-group-checkbox"
                    ${isMercadoLivreGroupSelected() ? 'checked' : ''}
                >
                <span style="flex: 1; margin-left: 5px;">üì¶ Mercado Livre</span>
            `;
            
            mlHeader.addEventListener('click', (e) => {
                if (e.target.type !== 'checkbox') {
                    toggleMercadoLivreGroup();
                }
            });
            
            mlHeader.querySelector('input').addEventListener('change', (e) => {
                toggleMercadoLivreGroupSelection();
            });
            
            const mlItems = document.createElement('div');
            mlItems.className = 'marketplace-group-items';
            
            const mlMarketplaces = state.marketplaces.filter((mp) => 
                mp.name.includes('Mercado Livre')
            );
            
            mlMarketplaces.forEach((mp) => {
                const index = state.marketplaces.findIndex(m => m.name === mp.name);
                const div = document.createElement('div');
                div.className = 'marketplace-item';
                div.innerHTML = `
                    <input 
                        type="checkbox" 
                        class="marketplace-checkbox"
                        id="mp-${index}"
                        ${state.selectedMarketplaces.includes(index) ? 'checked' : ''}
                    >
                    <span class="marketplace-item-name">${mp.name.replace('Mercado Livre ', '')}</span>
                    <span class="marketplace-commission">${(mp.commission * 100).toFixed(0)}%</span>
                `;
                
                div.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        document.getElementById(`mp-${index}`).click();
                    }
                });
                
                div.querySelector('input').addEventListener('change', () => {
                    toggleMarketplace(index);
                    updateMercadoLivreGroupCheckbox();
                });
                
                mlItems.appendChild(div);
            });
            
            mlGroup.appendChild(mlHeader);
            mlGroup.appendChild(mlItems);
            container.appendChild(mlGroup);

            // ==================== GRUPO SHOPEE ====================
            const shopeeGroup = document.createElement('div');
            shopeeGroup.className = 'marketplace-group expanded';
            
            const shopeeHeader = document.createElement('div');
            shopeeHeader.className = 'marketplace-group-header';
            shopeeHeader.innerHTML = `
                <svg class="group-expand-icon" viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
                <input 
                    type="checkbox" 
                    class="marketplace-checkbox"
                    id="shopee-group-checkbox"
                    ${isShopeeGroupSelected() ? 'checked' : ''}
                >
                <span style="flex: 1; margin-left: 5px;">üõçÔ∏è Shopee</span>
            `;
            
            shopeeHeader.addEventListener('click', (e) => {
                if (e.target.type !== 'checkbox') {
                    toggleShopeeGroup();
                }
            });
            
            shopeeHeader.querySelector('input').addEventListener('change', (e) => {
                toggleShopeeGroupSelection();
            });
            
            const shopeeItems = document.createElement('div');
            shopeeItems.className = 'marketplace-group-items';
            
            const shopeeMarketplaces = state.marketplaces.filter((mp) => 
                mp.name.includes('Shopee')
            );
            
            shopeeMarketplaces.forEach((mp) => {
                const index = state.marketplaces.findIndex(m => m.name === mp.name);
                const div = document.createElement('div');
                div.className = 'marketplace-item';
                div.innerHTML = `
                    <input 
                        type="checkbox" 
                        class="marketplace-checkbox"
                        id="mp-${index}"
                        ${state.selectedMarketplaces.includes(index) ? 'checked' : ''}
                    >
                    <span class="marketplace-item-name">${mp.name.replace('Shopee', '').trim() || 'Shopee Padr√£o'}</span>
                    <span class="marketplace-commission">${(mp.commission * 100).toFixed(0)}%</span>
                `;
                
                div.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        document.getElementById(`mp-${index}`).click();
                    }
                });
                
                div.querySelector('input').addEventListener('change', () => {
                    toggleMarketplace(index);
                    updateShopeeGroupCheckbox();
                });
                
                shopeeItems.appendChild(div);
            });
            
            shopeeGroup.appendChild(shopeeHeader);
            shopeeGroup.appendChild(shopeeItems);
            container.appendChild(shopeeGroup);

            // ==================== GRUPO TRAY ====================
            const trayGroup = document.createElement('div');
            trayGroup.className = 'marketplace-group expanded';
            
            const trayHeader = document.createElement('div');
            trayHeader.className = 'marketplace-group-header';
            trayHeader.innerHTML = `
                <svg class="group-expand-icon" viewBox="0 0 24 24">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
                <input 
                    type="checkbox" 
                    class="marketplace-checkbox"
                    id="tray-group-checkbox"
                    ${isTrayGroupSelected() ? 'checked' : ''}
                >
                <span style="flex: 1; margin-left: 5px;">üè™ Tray</span>
            `;
            
            trayHeader.addEventListener('click', (e) => {
                if (e.target.type !== 'checkbox') {
                    toggleTrayGroup();
                }
            });
            
            trayHeader.querySelector('input').addEventListener('change', (e) => {
                toggleTrayGroupSelection();
            });
            
            const trayItems = document.createElement('div');
            trayItems.className = 'marketplace-group-items';
            
            const trayMarketplaces = state.marketplaces.filter((mp) => 
                mp.name.includes('Tray')
            );
            
            trayMarketplaces.forEach((mp) => {
                const index = state.marketplaces.findIndex(m => m.name === mp.name);
                const div = document.createElement('div');
                div.className = 'marketplace-item';
                div.innerHTML = `
                    <input 
                        type="checkbox" 
                        class="marketplace-checkbox"
                        id="mp-${index}"
                        ${state.selectedMarketplaces.includes(index) ? 'checked' : ''}
                    >
                    <span class="marketplace-item-name">${mp.name.replace('Tray', '').trim() || 'Tray Padr√£o'}</span>
                    <span class="marketplace-commission">${(mp.commission * 100).toFixed(0)}%</span>
                `;
                
                div.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        document.getElementById(`mp-${index}`).click();
                    }
                });
                
                div.querySelector('input').addEventListener('change', () => {
                    toggleMarketplace(index);
                    updateTrayGroupCheckbox();
                });
                
                trayItems.appendChild(div);
            });
            
            trayGroup.appendChild(trayHeader);
            trayGroup.appendChild(trayItems);
            container.appendChild(trayGroup);

            // ==================== OUTROS MARKETPLACES ====================
            state.marketplaces.forEach((mp, index) => {
                if (mp.name.includes('Mercado Livre') || mp.name.includes('Shopee') || mp.name.includes('Tray')) {
                    return; // J√° adicionados nos grupos
                }
                
                const div = document.createElement('div');
                div.className = 'marketplace-item';
                div.innerHTML = `
                    <input 
                        type="checkbox" 
                        class="marketplace-checkbox"
                        id="mp-${index}"
                        ${state.selectedMarketplaces.includes(index) ? 'checked' : ''}
                    >
                    <span class="marketplace-item-name">${mp.name}</span>
                    <span class="marketplace-commission">${(mp.commission * 100).toFixed(0)}%</span>
                `;
                
                div.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        document.getElementById(`mp-${index}`).click();
                    }
                });
                
                div.querySelector('input').addEventListener('change', () => {
                    toggleMarketplace(index);
                });
                
                container.appendChild(div);
            });
        }

        function toggleMercadoLivreGroup() {
            state.mlGroupExpanded = !state.mlGroupExpanded;
            const group = document.querySelector('.marketplace-group');
            if (state.mlGroupExpanded) {
                group.classList.add('expanded');
            } else {
                group.classList.remove('expanded');
            }
        }

        function isMercadoLivreGroupSelected() {
            const mlIndices = state.marketplaces
                .map((mp, idx) => mp.name.includes('Mercado Livre') ? idx : -1)
                .filter(idx => idx !== -1);
            
            return mlIndices.every(idx => state.selectedMarketplaces.includes(idx));
        }

        function toggleMercadoLivreGroupSelection() {
            const mlIndices = state.marketplaces
                .map((mp, idx) => mp.name.includes('Mercado Livre') ? idx : -1)
                .filter(idx => idx !== -1);
            
            const allSelected = mlIndices.every(idx => state.selectedMarketplaces.includes(idx));
            
            mlIndices.forEach(idx => {
                if (allSelected) {
                    // Desmarcar todos
                    const position = state.selectedMarketplaces.indexOf(idx);
                    if (position > -1) {
                        state.selectedMarketplaces.splice(position, 1);
                    }
                } else {
                    // Marcar todos
                    if (!state.selectedMarketplaces.includes(idx)) {
                        state.selectedMarketplaces.push(idx);
                    }
                }
            });
            
            renderMarketplacesList();
            updateSelectedCount();
            renderResults();
        }

        function updateMercadoLivreGroupCheckbox() {
            const checkbox = document.getElementById('ml-group-checkbox');
            if (checkbox) {
                checkbox.checked = isMercadoLivreGroupSelected();
            }
        }

        // ==================== FUN√á√ïES PARA SHOPEE ====================

        function toggleShopeeGroup() {
            state.shopeeGroupExpanded = !state.shopeeGroupExpanded;
            const groups = document.querySelectorAll('.marketplace-group');
            if (groups[1]) {
                groups[1].classList.toggle('expanded');
            }
        }

        function isShopeeGroupSelected() {
            const shopeeIndices = state.marketplaces
                .map((mp, idx) => mp.name.includes('Shopee') ? idx : -1)
                .filter(idx => idx !== -1);
            
            return shopeeIndices.length > 0 && shopeeIndices.every(idx => state.selectedMarketplaces.includes(idx));
        }

        function toggleShopeeGroupSelection() {
            const shopeeIndices = state.marketplaces
                .map((mp, idx) => mp.name.includes('Shopee') ? idx : -1)
                .filter(idx => idx !== -1);
            
            const allSelected = shopeeIndices.every(idx => state.selectedMarketplaces.includes(idx));
            
            shopeeIndices.forEach(idx => {
                if (allSelected) {
                    const position = state.selectedMarketplaces.indexOf(idx);
                    if (position > -1) {
                        state.selectedMarketplaces.splice(position, 1);
                    }
                } else {
                    if (!state.selectedMarketplaces.includes(idx)) {
                        state.selectedMarketplaces.push(idx);
                    }
                }
            });
            
            renderMarketplacesList();
            updateSelectedCount();
            renderResults();
        }

        function updateShopeeGroupCheckbox() {
            const checkbox = document.getElementById('shopee-group-checkbox');
            if (checkbox) {
                checkbox.checked = isShopeeGroupSelected();
            }
        }

        // ==================== FUN√á√ïES PARA TRAY ====================

        function toggleTrayGroup() {
            state.trayGroupExpanded = !state.trayGroupExpanded;
            const groups = document.querySelectorAll('.marketplace-group');
            if (groups[2]) {
                groups[2].classList.toggle('expanded');
            }
        }

        function isTrayGroupSelected() {
            const trayIndices = state.marketplaces
                .map((mp, idx) => mp.name.includes('Tray') ? idx : -1)
                .filter(idx => idx !== -1);
            
            return trayIndices.length > 0 && trayIndices.every(idx => state.selectedMarketplaces.includes(idx));
        }

        function toggleTrayGroupSelection() {
            const trayIndices = state.marketplaces
                .map((mp, idx) => mp.name.includes('Tray') ? idx : -1)
                .filter(idx => idx !== -1);
            
            const allSelected = trayIndices.every(idx => state.selectedMarketplaces.includes(idx));
            
            trayIndices.forEach(idx => {
                if (allSelected) {
                    const position = state.selectedMarketplaces.indexOf(idx);
                    if (position > -1) {
                        state.selectedMarketplaces.splice(position, 1);
                    }
                } else {
                    if (!state.selectedMarketplaces.includes(idx)) {
                        state.selectedMarketplaces.push(idx);
                    }
                }
            });
            
            renderMarketplacesList();
            updateSelectedCount();
            renderResults();
        }

        function updateTrayGroupCheckbox() {
            const checkbox = document.getElementById('tray-group-checkbox');
            if (checkbox) {
                checkbox.checked = isTrayGroupSelected();
            }
        }

        function toggleMarketplace(index) {
            const idx = state.selectedMarketplaces.indexOf(index);
            if (idx > -1) {
                state.selectedMarketplaces.splice(idx, 1);
            } else {
                state.selectedMarketplaces.push(index);
            }
            updateSelectedCount();
            renderResults();
        }

        function toggleSelectAll() {
            if (state.selectedMarketplaces.length === state.marketplaces.length) {
                state.selectedMarketplaces = [];
            } else {
                state.selectedMarketplaces = state.marketplaces.map((_, i) => i);
            }
            renderMarketplacesList();
            updateSelectedCount();
            renderResults();
        }

        function updateSelectedCount() {
            const count = document.getElementById('selected-count');
            const btn = document.getElementById('select-all-btn');
            count.textContent = `${state.selectedMarketplaces.length} de ${state.marketplaces.length} marketplaces selecionados`;
            btn.textContent = state.selectedMarketplaces.length === state.marketplaces.length ? 'Desmarcar Todos' : 'Selecionar Todos';
        }

        // ==================== KITS ====================

        async function loadKits() {
            try {
                const response = await axios.get(`${state.apiUrl}/kits`);
                state.kits = response.data;
                updateKitDisplay();
            } catch (error) {
                console.error('‚ùå Erro ao carregar kits:', error);
            }
        }

        function updateKitDisplay() {
            const kitName = document.getElementById('kit-name');
            if (state.kits.length > 0) {
                kitName.textContent = state.kits[state.kitIndex].name;
            }
        }

        function prevKit() {
            state.kitIndex = state.kitIndex > 0 ? state.kitIndex - 1 : state.kits.length - 1;
            updateKitDisplay();
            debouncedCalculate();
        }

        function nextKit() {
            state.kitIndex = (state.kitIndex + 1) % state.kits.length;
            updateKitDisplay();
            debouncedCalculate();
        }

        // ==================== MARKETPLACE REVERSO ====================

        function updateMarketplaceDisplay() {
            const mpName = document.getElementById('marketplace-name');
            if (state.marketplaces.length > 0) {
                mpName.textContent = state.marketplaces[state.marketplaceIndex].name;
            }
        }

        function prevMarketplace() {
            state.marketplaceIndex = state.marketplaceIndex > 0 ? state.marketplaceIndex - 1 : state.marketplaces.length - 1;
            updateMarketplaceDisplay();
            calculateCost();
        }

        function nextMarketplace() {
            state.marketplaceIndex = (state.marketplaceIndex + 1) % state.marketplaces.length;
            updateMarketplaceDisplay();
            calculateCost();
        }

        // ==================== C√ÅLCULOS ====================

        function debouncedCalculate() {
            clearTimeout(state.debounceTimer);
            state.debounceTimer = setTimeout(() => {
                calculateAllPrices();
            }, 200);
        }

        async function calculateAllPrices() {
            if (state.cost <= 0 || state.marketplaces.length === 0) return;
            
            try {
                const response = await axios.post(`${state.apiUrl}/calculate-all-prices`, {
                    cost: state.cost,
                    margin: state.margin,
                    tax_rate: state.taxRate / 100,
                    kit_config_id: state.kitIndex
                });
                state.allPriceResults = response.data.results;
                console.log('‚úÖ Pre√ßos calculados:', state.allPriceResults.length, 'marketplaces');
                renderResults();
            } catch (error) {
                console.error('‚ùå Erro ao calcular pre√ßos:', error);
            }
        }

        async function calculateCost() {
            if (state.price <= 0 || state.marketplaces.length === 0) return;
            
            try {
                const response = await axios.post(`${state.apiUrl}/calculate-cost`, {
                    price: state.price,
                    margin: state.margin,
                    tax_rate: state.taxRate / 100,
                    marketplace_id: state.marketplaceIndex
                });
                state.costResults = response.data;
                updateReverseResults();
            } catch (error) {
                console.error('‚ùå Erro ao calcular custo:', error);
            }
        }

        function updateReverseResults() {
            const reverseDiv = document.getElementById('reverse-results');
            if (state.costResults) {
                document.getElementById('reverse-cost').textContent = `R$ ${state.costResults.cost}`;
                document.getElementById('reverse-shipment').textContent = `R$ ${state.costResults.shipment}`;
                reverseDiv.classList.remove('hidden');
            } else {
                reverseDiv.classList.add('hidden');
            }
        }

        // ==================== RENDERIZA√á√ÉO ====================

        function renderResults() {
            const filteredResults = state.allPriceResults.filter((result, index) => 
                state.selectedMarketplaces.includes(index)
            );

            const statsGrid = document.getElementById('stats-grid');
            const noStores = document.getElementById('no-stores-message');
            const loading = document.getElementById('loading-message');
            const resultsCard = document.getElementById('marketplaces-results-card');

            if (state.selectedMarketplaces.length === 0) {
                statsGrid.classList.add('hidden');
                noStores.classList.remove('hidden');
                loading.classList.add('hidden');
                resultsCard.classList.add('hidden');
                return;
            }

            if (filteredResults.length === 0) {
                statsGrid.classList.add('hidden');
                noStores.classList.add('hidden');
                loading.classList.remove('hidden');
                resultsCard.classList.add('hidden');
                return;
            }

            noStores.classList.add('hidden');
            loading.classList.add('hidden');
            statsGrid.classList.remove('hidden');
            resultsCard.classList.remove('hidden');

            // Atualizar estat√≠sticas
            const prices = filteredResults.map(r => r.single_price);
            const profits = filteredResults.map(r => r.profit);
            
            document.getElementById('stat-min-price').textContent = `R$ ${Math.min(...prices).toFixed(2)}`;
            document.getElementById('stat-max-price').textContent = `R$ ${Math.max(...prices).toFixed(2)}`;
            document.getElementById('stat-avg-price').textContent = `R$ ${(prices.reduce((a, b) => a + b, 0) / prices.length).toFixed(2)}`;
            
            const avgProfit = (profits.reduce((a, b) => a + b, 0) / profits.length).toFixed(2);
            const avgProfitEl = document.getElementById('stat-avg-profit');
            avgProfitEl.textContent = `R$ ${avgProfit}`;
            avgProfitEl.style.color = parseFloat(avgProfit) < 0 ? '#e53e3e' : '';

            // Atualizar contagem
            document.getElementById('results-count').textContent = filteredResults.length;
            document.getElementById('results-label').textContent = filteredResults.length === 1 ? 'marketplace' : 'marketplaces';

            // Renderizar lista
            const list = document.getElementById('marketplace-list');
            list.innerHTML = '';
            
            // Agrupar Mercado Livre se ambos estiverem selecionados
            const mlResults = filteredResults.filter(r => r.marketplace_name.includes('Mercado Livre'));
            const otherResults = filteredResults.filter(r => !r.marketplace_name.includes('Mercado Livre'));
            
            if (mlResults.length > 0) {
                const mlGroupDiv = document.createElement('div');
                mlGroupDiv.className = 'marketplace-results-group';
                
                const mlTitle = document.createElement('div');
                mlTitle.className = 'marketplace-results-group-title';
                mlTitle.textContent = 'üì¶ Mercado Livre';
                mlGroupDiv.appendChild(mlTitle);
                
                mlResults.forEach((result) => {
                    mlGroupDiv.appendChild(createMarketplaceRow(result));
                });
                
                list.appendChild(mlGroupDiv);
            }
            
            otherResults.forEach((result) => {
                list.appendChild(createMarketplaceRow(result));
            });

            // Adicionar event listeners para bot√µes de copiar
            document.querySelectorAll('.copy-btn, .kit-copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const price = this.getAttribute('data-price');
                    copyToClipboard(price, this);
                });
            });
        }

        function createMarketplaceRow(result) {
            const row = document.createElement('div');
            row.className = 'marketplace-row';
            row.innerHTML = `
                <div class="marketplace-name">${result.marketplace_name}</div>
                
                <div class="marketplace-info">
                    <div class="info-item">
                        <div class="info-label">Frete</div>
                        <div class="info-value">R$ ${result.shipment}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Comiss√£o</div>
                        <div class="info-value">R$ ${result.commission}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Impostos</div>
                        <div class="info-value">R$ ${result.tax}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Lucro</div>
                        <div class="info-value" style="color: ${result.profit < 0 ? '#e53e3e' : ''}">R$ ${result.profit}</div>
                    </div>
                </div>
                
                <div class="marketplace-price-container">
                    <div class="marketplace-price">R$ ${result.single_price}</div>
                    <button class="copy-btn" data-price="${result.single_price}">
                        <svg viewBox="0 0 24 24">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="kits-section">
                    ${result.kits.map(kit => `
                        <div class="kit-item">
                            <div class="kit-content">
                                <div class="kit-name">${kit.name}</div>
                                <div class="kit-price">R$ ${kit.price}</div>
                            </div>
                            <button class="kit-copy-btn" data-price="${kit.price}">
                                <svg viewBox="0 0 24 24">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
            return row;
        }

        async function copyToClipboard(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                
                button.classList.add('copied');
                button.innerHTML = `
                    <svg viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                `;
                
                setTimeout(() => {
                    button.classList.remove('copied');
                    button.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                        </svg>
                    `;
                }, 2000);
            } catch (error) {
                console.error('Erro ao copiar:', error);
            }
        }

        // ==================== EVENT LISTENERS ====================

        function setupEventListeners() {
            const themeBtn = document.getElementById('theme-toggle');
            if (themeBtn) {
                themeBtn.addEventListener('click', toggleTheme);
                console.log('‚úÖ Event listener do tema adicionado');
            }

            document.getElementById('btn-logout').addEventListener('click', logout);
            document.getElementById('select-all-btn').addEventListener('click', toggleSelectAll);

            document.getElementById('input-cost').addEventListener('input', (e) => {
                state.cost = parseFloat(e.target.value) || 0;
                debouncedCalculate();
            });

            document.getElementById('input-price').addEventListener('input', (e) => {
                state.price = parseFloat(e.target.value) || 0;
                calculateCost();
            });

            document.getElementById('input-margin').addEventListener('input', (e) => {
                state.margin = parseInt(e.target.value);
                const valueEl = document.getElementById('margin-value');
                valueEl.textContent = `${state.margin}% ${state.margin < 0 ? '(Preju√≠zo)' : ''}`;
                if (state.margin < 0) {
                    valueEl.style.color = '#e53e3e';
                } else {
                    valueEl.style.color = '';
                }
                debouncedCalculate();
                calculateCost();
            });

            document.getElementById('input-tax').addEventListener('input', (e) => {
                state.taxRate = parseFloat(e.target.value);
                document.getElementById('tax-value').textContent = `${state.taxRate}%`;
                debouncedCalculate();
                calculateCost();
            });

            document.getElementById('prev-kit').addEventListener('click', prevKit);
            document.getElementById('next-kit').addEventListener('click', nextKit);
            document.getElementById('prev-marketplace').addEventListener('click', prevMarketplace);
            document.getElementById('next-marketplace').addEventListener('click', nextMarketplace);
        }

        // ==================== INICIALIZA√á√ÉO ====================

        async function init() {
            console.log('üöÄ Iniciando aplica√ß√£o...');
            
            loadTheme();
            
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return;
            }

            document.getElementById('user-name').textContent = state.currentUser.name;
            setupEventListeners();

            await Promise.all([
                loadMarketplaces(),
                loadKits()
            ]);

            updateMarketplaceDisplay();

            document.getElementById('auth-loading').style.display = 'none';
            document.getElementById('app').classList.add('loaded');

            console.log('‚úÖ Aplica√ß√£o inicializada com sucesso!');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>